# u altered : Control signal is neither computed nor communicated during drop
# y altered : Sensor data is not communicated. Considered as 0. Residue is considered as 0
# U delayed : U[k]=-KXhat[k-1] Control signal is calculated based on previous estimation


import os
import numpy as np
import errno
############################## inputs ############################
modelName = "trajectory"

################## Patterns ###################

# patternList = [1]
patternList = [10,1100,110010,110100]
# patternList = [110,1011,11100,100011,11011,11110,111100,110011,1000111,1000111,10000111,10000111,1011100,1010011,10001011,10001110,11011100,11110100,11110010,11001011,11001110,100011011,100011110,100010111,100010111,100011110,100011101,1000011011,1000011110,1000010111,1000010111,1000011110,1000011101,1000111100,1000110011,1000111100,1000111001,1000100111,1000100111,110010001011,110010001110,110010100011,110010111000,110011100010,110011101000,110001001011,110001001110,110001010011,110001011100,110001110010,110001110100,110100100011,110100111000,110100010011,110100011100,110111001000,110111000100,111100100010,111100101000,111100010010,111100010100,111101001000,111101000100]
# patternList = [11010111100, 11010011]
# patternList = [11010,101011,10111,1010111,100111,110111,11010111,1100111,10001111,1101010,11010100,11001010,1011111,101011111,11100111,100011111,10111010,10101011,101011100,101010011,1000101011,1000111010,101010111,101111010,10100111,10111100,1010100111,1010111100,10001010111,10001111010,11011111,1101011111,111100111,110011111,1000111111,110111010,110101110,1101011100,1111001010,1100101011,1100111010,10001101011,10001110101,1101010111,1101111010,1101011110,110100111,110111100,110010111,110011110,1000110111,1000111110,1000101111,1000111101,11010100111,11001010111,11001111010,100011010111,100011111010,100010101111,100011110101,10001100111,10001111100,10001001111,10001111001]
# patternList = [1101001010,1100101010,10111010111,10111111010,10101011111,10111101011,1011100111,1011111100,1010011111,1011110011,10001011111,10001110111,10001111110,10001111011,101011100111,101011111100,101010011111,101011110011,1000101011111,1000111010111,1000111111010,1000111101011,100011100111,100011111100,100010011111,100011110011,10111001010,10111010100,10100111010,10100101011,10101011100,10101010011,100010111010,100010101011,100011101010,100010101110,101001010111,101001111010,101010100111,101010111100,101111001010,101111010100,1000101010111,1000101111010,1000101011110,1000111101010,100010100111,100010111100,100010010111,100010011110,100011110100,100011110010,10001010100111]
# patternList = [10001010111100,10001001010111,10001001111010,10001111010100,10001111001010,110111010111,110111111010,110101011111,110111101011,111101011110,11011100111,11011111100,11010011111,11011110011,11110010111,11110011110,11001011111,100011011111,100011110111,100011111110,100011111011,100010111111]
# patternList = [100011101111,100011111101,1101011100111,1101011111100,1101010011111,1101011110011,1111001010111,1111001111010,1100101011111,10001101011111,10001111010111,10001111111010,10001111101011,10001010111111,10001110101111,10001111110101,1000111100111,1000111111100,1000110011111,1000111110011,1000111001111,1000111111001,1000100111111,110111001010,110111010100,110100111010,110101011100,111100101010,110010111010,110010101011,110011101010,110010101110,110101110100,110101001011,110101001110,1000110111010,1000110101011,1000110101110,1000101101011,1000101110101,1000111011010,1000111010101,1000111010110,1000101011011,1000101011101,100011011100,100011010011,100011001011,100011001110,100010110011,100010111001,100011101100,100011101001,100011100110,100011100101,100010011011,100010011101,10001101011100,10001101010011,10001100101011,10001100111010,10001010110011,10001010111001,10001110101100,10001110101001,10001110011010,10001110010101,10001001101011,10001001110101,1101001010111,1101001111010,1101010100111,1101010111100,1101111001010,1101111010100,1100101010111,1100101111010,1100101011110,1100111101010,1101010010111,1101010011110]
# patternList = [10001101010111,10001101111010,10001101011110,10001111101010,10001011010111,10001011111010,10001010101111,10001011110101,10001010110111,10001010111110,10001010111101,10001111011010,10001111010101,10001111010110,1000110100111,1000110111100,1000110010111,1000110011110,1000111110100,1000111110010,1000101100111,1000101111100,1000101001111,1000101111001,1000100110111,1000100111110,1000100101111,1000100111101,1000111101100,1000111101001,1000111100110,1000111100101,100011010100111,100011010111100,100011001010111,100011001111010,100011111010100,100011111001010,100010101100111,100010101111100,100010101001111,100010101111001,100010011010111,100010011111010,100010010101111,100010011110101,100011110101100,100011110101001,100011110011010,100011110010101,10111001010111,10111001111010,10111010100111,10111010111100,10111111001010,10111111010100,10100111010111,10100111111010,10100101011111,10100111101011,10101011100111,10101011111100,10101010011111,10101011110011,10111100111010,10111100101011,10111101011100,10111101010011,100010111010111,100010111111010,100010101011111,100010111101011,100011101010111,100011101111010,100011101011110]
# patternList = [100011111101010,100010101110111,100010101111110,100010101111011,100011110111010,100011110101011,100011110101110,10001011100111,10001011111100,10001010011111,10001011110011,10001110100111,10001110111100,10001110010111,10001110011110,10001111110100,10001111110010,10001001011111,10001001110111,10001001111110,10001001111011,10001111011100,10001111010011,10001111001011,10001111001110,1000101011100111,1000101011111100,1000101010011111,1000101011110011,1000111010100111,1000111010111100,1000111001010111,1000111001111010,1000111111010100,1000111111001010,1000100101011111,1000100111010111,1000100111111010,1000100111101011,1000111101011100,1000111101010011,1000111100101011,1000111100111010,1000101001010111,1000101001111010,1000101010100111,1000101010111100,1000101111001010,1000101111010100,1000100101010111,1000100101111010,1000100101011110,1000100111101010,1000101010010111,1000101010011110,1000101011110100,1000101011110010,1000111101001010,1000111101010100,1000111100101010,1000111101010010,110010111111010,110010111010111,110010111101011,110010101011111,110011101111010,110011101010111,110011111101010,110011101011110,110011110111010]
# patternList = [110011110101011,110011110101110,110010101110111,110010101111110,110010101111011,110100111111010,110100111010111,110100111101011,110100101011111,110111111010100,110111010100111,110111010111100,110111100111010,110101010011111,111101111001010,111101111010100,111101010111100,111111101010010,111101010010111,111101010011110,111101011110010,111101011110100,110101001011111,110101001110111,110101001111110,110101001111011,110101110111100,1100010111111010,1100010111010111,1100010111101011,1100010101011111,1100011101111010,1100011101010111,1100011111101010,1100011101011110,1100011110111010,1100011110101011,1100011110101110,1100010101110111,1100010101111110,1100010101111011,1101000111111010,1101000111010111,1101000111101011,1101000101011111,1101111110101000,1101110101000111,1101110101111000,1101111000111010,1101010100011111,1111011110001010,1111011110101000,1111010101111000,1111111010100010,1111010100010111,1111010100011110,1111010111100010,1111010111101000,1101010001011111,1101010001110111,1101010001111110,1101010001111011,1101011101111000,110010001011111,110010001110111,110010001111110,110010001111011,110010100011111,110010111000111]
# patternList = [110010111111000,110010111100011,110011100010111,110011100011110,110011101000111,110011101111000,110011111100010,110011111101000,110011110001011,110011110001110,110011110100011,110011110111000,110001001011111,110001001110111,110001001111110,110001001111011,110001010011111,110001110100111,110001110111100,110001111110100,110001111001110,110100100011111,110100111000111,110100111111000,110100111100011,110100010011111,110111000111100,111100010111100,111100011110010,111100011110100,111101000111100,111101111001000,111101111000100,11001000111111010,11001000111010111,11001000111101011,11001000101011111,11001110001111010,11001110001010111,11001111110001010,11001111110101000,11001110101000111,11001110101111000,11001111000111010,11001111000101011,11001111010100011,11001111010111000,11001010100011111,11001010111000111,11001010111111000,11001010111100011,11000100111111010,11000100111010111,11000100111101011,11000100101011111,11000111111010100,11000111010100111,11000111010111100,11000111100111010,11000101010011111,11110001111001010,11110001111010100,11110001010111100,11111110101001000,11111110101000100,11110101001000111,11110101001111000]
# patternList = [11110101000100111,11110101000111100,11110101111001000,11110101111000100,11010100100011111,11010100111000111,11010100111111000,11010100111100011,11010100010011111,11010111000111100,1100100010111010,1100100010101011,1100100011101010,1100100010101110,1100101000111010,1100101000101011,1100101110001010,1100101110101000,1100101010100011,1100101010111000,1100111000101010,1100111010001010,1100111010101000,1100111010100010,1100101010001011,1100101010001110,1100101011100010,1100101011101000,1100010010111010,1100010011101010,1100010010101110,1100010100111010,1100010111010100,1100011101001010,1100011101010100,1100011101010010,1100010101001110,1100010101110100,1101001000111010,1101001000101011,1101001110001010,1101001110101000,1101001010100011,1101001010111000,1101000100111010,1101000100101011,1101000111010100,1101110001001010,1101110001010100,1101110101001000,1101110101000100,1101010100100011,1101010100111000,1101010111000100,1111010001010100,1111010101000100,1111010100100010,1111010100101000,1111010100010010,1111010100010100,1101010010100011,1101010010111000,1101010011100010,1101011100010010,1101011100010100,11001000101111010,11001000101010111]
# patternList = [11001000111101010,11001000101011110,11001010001111010,11001010001010111,11001011110001010,11001011110101000,11001010101000111,11001010101111000,11001111000101010,11001111010001010,11001111010101000,11001111010100010,11001010100010111,11001010100011110,11001010111100010,11001010111101000,11000100101111010,11000100101010111,11000100111101010,11000100101011110,11000101001111010,11000101001010111,11000101111001010,11000101111010100,11000101010100111,11000101010111100,11000111100101010,11000111101001010,11000111101010100,11000111101010010,11000101010010111,11000101010011110,11000101011110010,11000101011110100,11010010001111010,11010010001010111,11010011110001010,11010011110101000,11010010101000111,11010010101111000,11010001001111010,11010001001010111,11010001111001010,11010001111010100,11010001010100111,11010001010111100,11011110010001010,11011110010101000,11011110001001010,11011110001010100,11011110101001000,11011110101000100,11010101001000111,11010101001111000,11010101000100111,11010101000111100,11010101111001000,11010101111000100,11111010100100010,11111010100101000,11111010100010010,11111010100010100,11010100100010111,11010100100011110]
# patternList = [11010100101000111,11010100101111000,11010100111100010,11010100111101000,11010100010010111,11010100010011110,11010100010100111,11010100010111100,11010100011110010,11010100011110100,11010111100100010,11010111100101000,11010111100010010,11010111100010100,11010111101001000,11010111101000100,100100010111111010,100100010111010111,100100010111101011,100100010101011111,100100011101111010,100100011101010111,100100011111101010,100100011101011110,100100011110111010,100100011110101011,100100011110101110,100100010101110111,100100010101111110,100100010101111011,100101000111111010,100101000111010111,100101000111101011,100101000101011111,100101110001111010,100101110001010111,100101111110001010,100101111110101000,100101110101000111,100101110101111000,100101111000111010,100101111000101011,100101111010100011,100101111010111000,100101010100011111,100101010111000111,100101010111111000,100101010111100011,100111000101111010,100111000101010111,100111000111101010,100111000101011110,100111010001111010,100111010001010111,100111011110001010,100111011110101000,100111010101000111,100111010101111000,100111111000101010,100111111010001010,100111111010101000,100111111010100010]
# patternList = [100111010100010111,100111010100011110,100111010111100010,100111010111101000,100111100010111010,100111100010101011,100111100011101010,100111100010101110,100111101000111010,100111101000101011,100111101110001010,100111101110101000,100111101010100011,100111101010111000,100111101010001011,100111101010001110,100111101011100010,100111101011101000,100101010001011111,100101010001110111,100101010001111110,100101010001111011,100101011100010111,100101011100011110,100101011101000111,100101011101111000,100101011111100010,100101011111101000,100101011110001011,100101011110001110,100101011110100011,100101011110111000,1100100010111111010,1100100010111010111,1100100010111101011,1100100010101011111,1100100011101111010,1100100011101010111,1100100011111101010,1100100011101011110,1100100011110111010,1100100011110101011,1100100011110101110,1100100010101110111,1100100010101111110,1100100010101111011,1100101000111111010,1100101000111010111,1100101000111101011,1100101000101011111,1100101110001111010,1100101110001010111,1100101111110001010,1100101111110101000,1100101110101000111,1100101110101111000,1100101111000111010,1100101111000101011,1100101111010100011,1100101111010111000]
# patternList = [1100101010100011111,1100101010111000111,1100101010111111000,1100101010111100011,1100111000101111010,1100111000101010111,1100111000111101010,1100111000101011110,1100111010001111010,1100111010001010111,1100111011110001010,1100111011110101000,1100111010101000111,1100111010101111000,1100111111000101010,1100111111010001010,1100111111010101000,1100111111010100010,1100111010100010111,1100111010100011110,1100111010111100010,1100111010111101000,1100111100010111010,1100111100010101011,1100111100011101010,1100111100010101110,1100111101000111010,1100111101000101011,1100111101110001010,1100111101110101000,1100111101010100011,1100111101010111000,1100111101010001011,1100111101010001110,1100111101011100010,1100111101011101000,1100101010001011111,1100101010001110111,1100101010001111110,1100101010001111011,1100101011100010111,1100101011100011110,1100101011101000111,1100101011101111000,1100101011111100010,1100101011111101000,1100101011110001011,1100101011110001110,1100101011110100011,1100101011110111000,1100010010111111010,1100010010111010111,1100010010111101011,1100010010101011111,1100010011101111010,1100010011101010111,1100010011111101010,1100010011101011110,1100010011110111010]
# patternList = [1100010011110101011,1100010011110101110,1100010010101110111,1100010010101111110,1100010010101111011,1100010100111111010,1100010100111010111,1100010100111101011,1100010100101011111,1100010111111010100,1100010111010100111,1100010111010111100,1100010111100111010,1100010101010011111,1100011101001111010,1100011101001010111,1100011101111001010,1100011101111010100,1100011101010100111,1100011101010111100,1100011111101001010,1100011111101010100,1100011111101010010,1100011101010010111,1100011101010011110,1100011101011110010,1100011101011110100,1100011110010111010,1100011110011101010,1100011110010101110,1100011110100111010,1100011110100101011,1100011110111010100,1100011110101001011,1100011110101001110,1100011110101110100,1100010101001011111,1100010101001110111,1100010101001111110,1100010101001111011,1100010101110100111,1100010101110111100,1100010101111110100,1100010101111001110,1101001000111111010,1101001000111010111,1101001000111101011,1101001000101011111,1101001110001010111,1101001111110001010,1101001111110101000,1101001110101000111,1101001110101111000,1101001111000111010,1101001111000101011,1101001111010100011,1101001111010111000,1101001010100011111,1101000100111111010]
# patternList = [1101000100111010111,1101000100111101011,1101000100101011111,1101000111111010100,1101000111010100111,1101000111010111100,1101000111100111010,1101000101010011111,1101110001111001010,1101110001010111100,1101111110101001000,1101111110101000100,1101110101001000111,1101110101001111000,1101110101000100111,1101110101000111100,1101110101111001000,1101110101111000100,1101111001000111010,1101111001110101000,1101111000100111010,1101111000111010100,1101010100100011111,1101010100111000111,1101010100111111000,1101010100111100011,1101010100010011111,1101010111000111100,1111000101111001010,1111000101111010100,1111000101010111100,1111000111100101010,1111000111101010100,1111000101011110010,1111000101011110100,1111010010101111000,1111010001111001010,1111010001111010100,1111010001010111100,1111011110010001010,1111011110010101000,1111011110001001010,1111011110001010100,1111011110101001000,1111011110101000100,1111010101000111100,1111010101111001000,1111010101111000100,1111111010100100010,1111111010100101000,1111111010100010010,1111111010100010100,1111010100100010111,1111010100100011110,1111010100101000111,1111010100101111000,1111010100111100010,1111010100111101000,1111010100010010111]
# patternList = [1111010100010011110,1111010100010100111,1111010100010111100,1111010100011110010,1111010100011110100,1111010111100100010,1111010111100101000,1111010111100010010,1111010111100010100,1111010111101001000,1111010111101000100,1101010010001011111,1101010010001110111,1101010010001111110,1101010010001111011,1101010010100011111,1101010011100010111,1101010011101000111,1101010011101111000,1101010011111100010,1101010011111101000,1101010011110001011,1101010011110001110,1101010011110100011,1101010011110111000,1101010001001011111,1101010001001110111,1101010001001111110,1101010001001111011,1101010001010011111,1101010001110111100,1101011100010111100,1101011100011110010,1101011101000111100,1101011101111001000,1101011101111000100]

#########################################
initAttackLen = 24
offset = 4
start = 0
isSat = 0
innerCircleDepth = 0.2
isDelayed = 0
yAffected = 0
####################################################################
if modelName == "tempControl":
    modelName= "tempControl"
    A= np.matrix('0.94648514795348381856143760160194 0.0018971440127071483982418298452899;0 0.000000000013887943864964020896356969649573')
    B= np.matrix('-0.046752721484125708828472056666214;-0.99999999998611222018496391683584')
    C= np.matrix('1 0')
    D= np.matrix('0')
    Gain= np.matrix('-0.3712408426327057364702000086254 -0.0007441187601164687840174516431091')
    L= np.matrix('0.60711740001928504728567759229918;0.39288259998275032458536770718638')
    safex = [30,30]
    tolerance = [1,1]
    th = 0.00001
elif modelName == "trajectory":
    A= np.matrix('1.0000    0.1000;0    1.0000')
    B= np.matrix('0.0050;0.1000')
    C= np.matrix('1 0')
    D= np.matrix('0')
    Gain= np.matrix('16.0302    5.6622')  # settling time around 10
    L = np.matrix('0.9902;0.9892')
    safex = [25,30]
    tolerance = [1,1]
    th = 2
    sensorRange = [3000000]
    actuatorRange = [36]
elif modelName == "trajectory_pajic":# model from pajic's sporadic MAC CDC paper
    A= np.matrix('1.0000    0.1000;0    1.0000')
    B= np.matrix('0.0001;0.01')
    C= np.matrix('1 0')
    D= np.matrix('0')
    Gain= np.matrix('16.0302    5.6622')  # settling time around 10
    L = np.matrix('0.6180 0.0011;0.0011 0.6180')
    safex = [0.025,0.025]
    tolerance = [0.1,0.1]
    th = 0.035
# elif modelName == "esp":
#     A= np.matrix('0.4450 -0.0458;1.2939 0.4402')
#     B= np.matrix('0.0550;4.5607')
#     C= np.matrix('0 1')
#     D= np.matrix('0')
#     Gain= np.matrix('-0.0987 0.1420')
#     L= np.matrix('-0.0390;0.4339')
#     safex = [1,2]
#     tolerance = [0.1,0.1]
#     th = 0.8
#     sensorRange = [2.5]
#     actuatorRange = [0]
elif modelName == "esp":
    A= np.matrix(' 0.6278   -0.0259;0.4644    0.7071')
    B= np.matrix(' 0.1246   -0.00000028;    3.2763    0.000016')
    C= np.matrix('0    1.0000;-338.7813    1.1293')
    D= np.matrix('0         0;  169.3907         0')
    Gain= np.matrix('0.1365    0.1977;-0.0000    0.0000')
    L= np.matrix('-0.000000000027085 -0.000000000636120;0.000000000336712 0.0000000055631')
    safex = [1,2]
    tolerance = [0.1,0.1]
    th = 0.8
    sensorRange = [2.5]
    actuatorRange = [15]
elif modelName == "powersystem":
    A= np.matrix('0.66 0.53;-0.53 0.13')
    B= np.matrix('0.34;0.53')
    C= np.matrix('1 0;0 1')
    D= np.matrix('0;0')
    Gain= np.matrix('0.0556 0.3306')
    L= np.matrix('0.36 0.27;  -0.31 0.08')
    safex = [0.1,0.05]
    tolerance = [0.001,0.0001]
    # initialRange = np.matrix('0 0.35;-4 4')
    th = 0.03
elif modelName == "plant":
    A= np.matrix('2.6221    0.3197    1.8335   -1.0664; -0.2381    0.1872   -0.1361    0.2017; 0.1612    0.7888    0.2859    0.6064;-0.1035    0.7641    0.0886    0.7360')
    B= np.matrix('0.4654   -1.5495; 1.3138    0.0851; 2.0549   -0.6730; 2.0227   -0.1597')
    C= np.matrix('1     0     1    -1;0     1     0     0')
    D= np.matrix('0 0;0 0')
    Gain= np.matrix('-0.2580    0.3159   -0.1087    0.3982; -1.6195   -0.1314   -1.1232    0.7073')
    L= np.matrix('2.4701   -0.0499; -0.2144    0.0224; 0.2327    0.0946; -0.0192    0.1004')
    safex = [0.01,0.01,0.01,0.01]
    tolerance = [0.0001,0.0001,0.0001,0.0001]
    th = 0.0001
elif modelName == "powergrid":
    A= np.matrix('-1 -3;3 -5')
    B= np.matrix('2 -1;1 0')
    C= np.matrix('0.8 2.4;1.6 0.8')
    D= np.matrix('0 0; 0 0')
    Gain= np.matrix('2.9846   -4.9827;6.9635   -6.9599')
    L= np.matrix('-1.1751   -0.1412;-2.6599    2.2549')
    safex = [0.1,0.2]
    tolerance = [0.001,0.001]
    th = 0.01

################## creating the path to save results #################
path="../results/z3/"+modelName+"/"
try:
    os.makedirs(path)
except OSError as err:
    if err.errno!= errno.EEXIST:
        raise
#####################################################################
u_count=B.shape[1]
x_count=A.shape[1]
y_count=C.shape[0]

######### Configure which sensor/control input to attack ##########
u_attack_map = np.zeros(u_count,dtype=float)
y_attack_map = np.zeros(y_count,dtype=float)
u_attack_map[0] = 1
y_attack_map[0] = 1

######### Configure which sensor/control input to attack ##########
initialRange = np.zeros(shape=(x_count,2), dtype=float)
for i in range(x_count):
    initialRange[i,0] = (-1)*safex[i]*innerCircleDepth
    initialRange[i,1] = safex[i]*innerCircleDepth

print(set(patternList))
#Compute pattern length
for pattern in set(patternList):
    print("Running for "+str(pattern))
    patternLen=len(str(pattern))

    #Compute pattern array
    patternArray = np.zeros((patternLen), dtype=int)
    patternTemp = pattern
    i = patternLen-1
    while patternTemp>0:
        patternArray[i] = patternTemp%10
        patternTemp=patternTemp//10
        i = i-1

    f0 = open(path+modelName+"_downtime.z3result", "w+")
    f0.write("0")
    f0.close()

    print("Finding minimum attack length for "+str(modelName)+" and pattern "+str(pattern))
    isSat = 0
    attackLen = initAttackLen
    while isSat == 0:
        print("attack length:"+str(attackLen)+"\n")
        index = start
        while (index<patternLen) and (isSat == 0):
            print("attack start at "+str(index))
            # create drop pattern
            K = index + attackLen + offset
            dropPattern = np.ones((K), dtype=int)
            j=0
            if pattern!=1:
                for i in range(K):
                    dropPattern[i] = patternArray[j]
                    j = j + 1
                    if j == patternLen:
                        j = 0
            print("drop pattern:")
            print(dropPattern)
            print("\n")
            # fileName = modelName + "_combined_" + str(th) + "_" +str(index)+"_"+str(attackLen)+"_"+str(K)+"_"+str(pattern)+".py"
            fileName = modelName + "_combined_"+ str(innerCircleDepth)+"_" + str(th) + "_"+str(attackLen)+"_"+str(pattern)+".py"
            f = open(path+fileName, "w+")
            f.write("#U altered, Y altered*\n")
            f.write("from z3 import *\n")
            f.write("import math\n")
            f.write("import numpy as np\n\n")
            f.write("s = Solver()\n")
            # f.write("set_option(precision=40)\n")
            f.write("set_option(rational_to_decimal=True)\n")
            # declaring variables
            for varcount in range(1,x_count+1):
                f.write("xabs"+str(varcount)+" = np.zeros("+str(K+1)+", dtype=float)\n")
                f.write("x"+str(varcount)+" = np.zeros("+str(K+1)+", dtype=float)\n")
                f.write("z"+str(varcount)+" = np.zeros("+str(K+1)+", dtype=float)\n")
            for varcount in range(1,y_count+1):
                f.write("y"+str(varcount)+" = np.zeros("+str(K+1)+", dtype=float)\n")
                f.write("attackOnY"+str(varcount)+" = np.zeros("+str(K+1)+", dtype=float)\n")
                f.write("r"+str(varcount)+" = np.zeros("+str(K+1)+", dtype=float)\n")
            for varcount in range(1,u_count+1):
                f.write("u"+str(varcount)+" = np.zeros("+str(K+1)+", dtype=float)\n")
                f.write("uattacked"+str(varcount)+" = np.zeros("+str(K+1)+", dtype=float)\n")
                f.write("attackOnU"+str(varcount)+" = np.zeros("+str(K+1)+", dtype=float)\n")
            f.write("r = np.zeros("+str(K+1)+", dtype=float)\n\n")

            for i in range(K+1):
                decl=""
                for varcount in range(1,y_count+1):
                    decl+="y"+str(varcount)+"_"+str(i)+" = Real('y"+str(varcount)+"_"+str(i)+"')\n"
                    decl+="r"+str(varcount)+"_"+str(i)+" = Real('r"+str(varcount)+"_"+str(i)+"')\n"
                    decl+="rabs"+str(varcount)+"_"+str(i)+" = Real('rabs"+str(varcount)+"_"+str(i)+"')\n"

                for varcount in range(1,x_count+1):
                    decl+="x"+str(varcount)+"_"+str(i)+" = Real('x"+str(varcount)+"_"+str(i)+"')\n"
                    decl+="z"+str(varcount)+"_"+str(i)+" = Real('z"+str(varcount)+"_"+str(i)+"')\n"
                    decl+="xabs"+str(varcount)+"_"+str(i)+" = Real('xabs"+str(varcount)+"_"+str(i)+"')\n"

                for varcount in range(1,u_count+1):
                    decl+="u"+str(varcount)+"_"+str(i)+" = Real('u"+str(varcount)+"_"+str(i)+"')\n"
                    decl+="uattacked"+str(varcount)+"_"+str(i)+" = Real('uattacked"+str(varcount)+"_"+str(i)+"')\n"

                decl+="r_"+str(i)+" = Real('r_"+str(i)+"')\n"
                f.write(decl)
            #initial range declaration of variables
            f.write("\n")
            for varcount in range(1,x_count+1):
                f.write("s.add(x"+str(varcount)+"_0 >= "+str(initialRange[varcount-1,0])+")\n")
                f.write("s.add(x"+str(varcount)+"_0 <= "+str(initialRange[varcount-1,1])+")\n")
                f.write("s.add(z"+str(varcount)+"_0 == 0)\n")
                f.write("s.add(xabs"+str(varcount)+"_0 == If(x"+str(varcount)+"_0<0,(-1)*x"+str(varcount)+"_0,x"+str(varcount)+"_0))\n")
            for varcount1 in range(1,y_count+1):
                f.write("s.add(y"+str(varcount1)+"_0 == 0)\n")
            for varcount2 in range(1,u_count+1):
                f.write("s.add(u"+str(varcount2)+"_0 == 0)\n")
                f.write("s.add(uattacked"+str(varcount2)+"_0 == 0)\n")
            f.write("\n")

            j = 0
            for i in range(K):
                f.write("# pattern = "+str(dropPattern[i])+"\n")

                # Update r
                expr_r=""
                for varcount1 in range(1,y_count+1):
                    if i>0 and dropPattern[i-1]==0 and yAffected:
                        expr_r+="s.add(r"+str(varcount1)+"_"+str(i)+" == 0)\n"
                    else:
                        expr_r+="s.add(r"+str(varcount1)+"_"+str(i)+" == y"+str(varcount1)+"_"+str(i)
                        for varcount2 in range(1,x_count+1):
                            expr_r+=" - ("+str(C[varcount1-1,varcount2-1])+"*z"+str(varcount2)+"_"+str(i)+")"
                        for varcount3 in range(1,u_count+1):
                            expr_r+=" - ("+str(D[varcount1-1,varcount3-1])+"*u"+str(varcount3)+"_"+str(i)+")"
                        expr_r+=")\n"

                f.write(expr_r)

                # Compute 1-norm of r
                expr_rabs = ""
                expr_r = "s.add(r_"+str(i)+" =="
                for varcount1 in range(1,y_count+1):
                    expr_rabs+= "s.add(rabs"+str(varcount1)+"_"+str(i)+" == If(r"+str(varcount1)+"_"+str(i)+"<0,(-1)*r"+str(varcount1)+"_"+str(i)+",r"+str(varcount1)+"_"+str(i)+"))\n"
                    expr_r+="rabs"+str(varcount1)+"_"+str(i)+" +"
                expr_r = expr_r[:len(expr_r)-1]
                expr_r+=")\n"
                f.write(expr_rabs)
                f.write(expr_r)

                # Threshold check
                f.write("s.add(r_{0}<{1})\n".format(i,th))

                # Update x and z
                expr_x=""
                expr_xabs=""
                expr_z=""
                for varcount1 in range(1,x_count+1):
                    expr_x+="s.add(x"+str(varcount1)+"_"+str(i+1)+" == "
                    expr_z+="s.add(z"+str(varcount1)+"_"+str(i+1)+" == "
                    for varcount2 in range(1,x_count+1):
                        expr_x+=" ("+str(A[varcount1-1,varcount2-1])+"*x"+str(varcount2)+"_"+str(i)+") +"
                        expr_z+=" ("+str(A[varcount1-1,varcount2-1])+"*z"+str(varcount2)+"_"+str(i)+") +"
                    for varcount3 in range(1,u_count+1):
                        expr_z+=" ("+str(B[varcount1-1,varcount3-1])+"*u"+str(varcount3)+"_"+str(i)+") +"
                        expr_x+=" ("+str(B[varcount1-1,varcount3-1])+"*uattacked"+str(varcount3)+"_"+str(i)+") +"
                    for varcount4 in range(1,y_count+1):
                        expr_z+=" ("+str(L[varcount1-1,varcount4-1])+"*r"+str(varcount4)+"_"+str(i)+") +"

                    expr_xabs+="s.add(xabs"+str(varcount1)+"_"+str(i+1)+" == If(x"+str(varcount1)+"_"+str(i+1)+"<0,(-1)*x"+str(varcount1)+"_"+str(i+1)+",x"+str(varcount1)+"_"+str(i+1)+"))\n"

                    expr_x=expr_x[:len(expr_x)-1]
                    expr_x = expr_x + ")\n"
                    expr_z=expr_z[:len(expr_z)-1]
                    expr_z = expr_z + ")\n"

                f.write(expr_z)
                f.write(expr_x)
                f.write(expr_xabs)

                # Simulate dropping behavior
                if dropPattern[i]: #If there is a 1 in the pattern
                    expr_u=""
                    for varcount1 in range(1,u_count+1):
                        expr_u+="s.add(u"+str(varcount1)+"_"+str(i+1)+" == "
                        for varcount2 in range(1,x_count+1):
                            if isDelayed:
                                expr_u+=" - ("+str(Gain[varcount1-1,varcount2-1])+"*z"+str(varcount2)+"_"+str(i)+")"
                            else:
                                expr_u+=" - ("+str(Gain[varcount1-1,varcount2-1])+"*z"+str(varcount2)+"_"+str(i+1)+")"
                        expr_u+=")\n"
                    f.write(expr_u)
                    if i == (j+index):      # If in this iteration we can give an attack
                        expr_uatk=""
                        for varcount1 in range(1,u_count+1):
                            f.write("attackOnU"+str(varcount1)+"_"+str(i)+" = Real('attackOnU"+str(varcount1)+"_"+str(i)+"')\n")
                            expr_uatk+="s.add(uattacked"+str(varcount1)+"_"+str(i+1)+" == u"+str(varcount1)+"_"+str(i+1)+"+ ("+str(u_attack_map[varcount1-1])+"*attackOnU"+str(varcount1)+"_"+str(i)+"))\n"
                        f.write(expr_uatk)

                        if yAffected:
                            expr_y=""
                            for varcount1 in range(1,y_count+1):
                                f.write("attackOnY"+str(varcount1)+"_"+str(i)+" = Real('attackOnY"+str(varcount1)+"_"+str(i)+"')\n")
                                expr_y+="s.add(y"+str(varcount1)+"_"+str(i+1)+" == ("+str(y_attack_map[varcount1-1])+"*attackOnY"+str(varcount1)+"_"+str(i)+")"
                                for varcount2 in range(1,x_count+1):
                                    expr_y+=" + ("+str(C[varcount1-1,varcount2-1])+"*x"+str(varcount2)+"_"+str(i+1)+")"
                                for varcount3 in range(1,u_count+1):
                                    expr_y+=" + ("+str(D[varcount1-1,varcount3-1])+"*u"+str(varcount3)+"_"+str(i+1)+")"
                                expr_y+=")\n"
                            f.write(expr_y)

                            j = j+1
                            if j== attackLen:
                                j=0

                    else: # If attack len exhausted
                        expr_uatk=""
                        for varcount1 in range(1,u_count+1):
                            expr_uatk+="s.add(uattacked"+str(varcount1)+"_"+str(i+1)+" == u"+str(varcount1)+"_"+str(i+1)+")\n"
                        f.write(expr_uatk)

                        if yAffected:
                            expr_y=""
                            for varcount1 in range(1,y_count+1):
                                expr_y+="s.add(y"+str(varcount1)+"_"+str(i+1)+" == "
                                for varcount2 in range(1,x_count+1):
                                    expr_y+=" + ("+str(C[varcount1-1,varcount2-1])+"*x"+str(varcount2)+"_"+str(i+1)+")"
                                for varcount3 in range(1,u_count+1):
                                    expr_y+=" + ("+str(D[varcount1-1,varcount3-1])+"*u"+str(varcount3)+"_"+str(i+1)+")"
                                expr_y+=")\n"
                            f.write(expr_y)
                else:
                    expr_u=""
                    for varcount1 in range(1,u_count+1):
                        expr_u+="s.add(u"+str(varcount1)+"_"+str(i+1)+" == u"+str(varcount1)+"_"+str(i)+")\n"
                        expr_u+="s.add(uattacked"+str(varcount1)+"_"+str(i+1)+" == uattacked"+str(varcount1)+"_"+str(i)+")\n"
                    f.write(expr_u)

                    if yAffected:
                        expr_y=""
                        for varcount1 in range(1,y_count+1):
                            expr_y+="s.add(y"+str(varcount1)+"_"+str(i+1)+" == 0)\n"
                        f.write(expr_y)

                        if i == (j+index):
                            j = j + 1
                            if j == attackLen:
                                j=0

                expr_u=""
                for varcount1 in range(1,u_count+1):
                    if u_attack_map[varcount1-1] and actuatorRange[varcount1-1]!=0:
                        expr_u+="s.add(And(u"+str(varcount1)+"_"+str(i+1)+">-"+str(actuatorRange[varcount1-1])+",u"+str(varcount1)+"_"+str(i+1)+"<"+str(actuatorRange[varcount1-1])+"))\n"
                        expr_u+="s.add(And(uattacked"+str(varcount1)+"_"+str(i+1)+">-"+str(actuatorRange[varcount1-1])+",uattacked"+str(varcount1)+"_"+str(i+1)+"<"+str(actuatorRange[varcount1-1])+"))\n"
                f.write(expr_u)

                # Update y when drop has no effect on y
                if yAffected==0:
                    if i == (j+index):
                        expr_y=""
                        for varcount1 in range(1,y_count+1):
                            f.write("attackOnY"+str(varcount1)+"_"+str(i)+" = Real('attackOnY"+str(varcount1)+"_"+str(i)+"')\n")
                            expr_y+="s.add(y"+str(varcount1)+"_"+str(i+1)+" == ("+str(y_attack_map[varcount1-1])+"*attackOnY"+str(varcount1)+"_"+str(i)+")"
                            for varcount2 in range(1,x_count+1):
                                expr_y+=" + ("+str(C[varcount1-1,varcount2-1])+"*x"+str(varcount2)+"_"+str(i+1)+")"
                            for varcount3 in range(1,u_count+1):
                                expr_y+=" + ("+str(D[varcount1-1,varcount3-1])+"*uattacked"+str(varcount3)+"_"+str(i+1)+")"
                            expr_y+=")\n"
                        f.write(expr_y)
                        j = j+1
                        if j== attackLen:
                            j=0
                    else:
                        expr_y=""
                        for varcount1 in range(1,y_count+1):
                            expr_y+="s.add(y"+str(varcount1)+"_"+str(i+1)+" == "
                            for varcount2 in range(1,x_count+1):
                                expr_y+=" + ("+str(C[varcount1-1,varcount2-1])+"*x"+str(varcount2)+"_"+str(i+1)+")"
                            for varcount3 in range(1,u_count+1):
                                expr_y+=" + ("+str(D[varcount1-1,varcount3-1])+"*uattacked"+str(varcount3)+"_"+str(i+1)+")"
                            expr_y+=")\n"
                        f.write(expr_y)


                expr_y=""
                for varcount1 in range(1,y_count+1):
                    if y_attack_map[varcount1-1] and sensorRange[varcount1-1]!=0:
                        expr_y+="s.add(And(y"+str(varcount1)+"_"+str(i+1)+">-"+str(sensorRange[varcount1-1])+",y"+str(varcount1)+"_"+str(i+1)+"<"+str(sensorRange[varcount1-1])+"))\n"
                f.write(expr_y)

            f.write("s.add(Or(")
            assertion=""
            for varcount in range(1,x_count+1):
                for i in range(K):
                    assertion+="(xabs"+str(varcount)+"_"+str(i)+" - "+str(safex[varcount-1])+")>"+str(tolerance[varcount-1])+","
            assertion = assertion[:len(assertion)-1]
            f.write(assertion)
            f.write("))\n")

            # f.write("\nprint(s.sexpr())")
            f.write("\nif s.check() != sat:\n")
            f.write("\tprint(s.check())\n")
            f.write
            f.write("\tisSat = 0\n")
            f.write("else:\n")
            f.write("\tprint(s.check())\n")
            f.write("\tisSat = 1\n")
            f.write("\tf0 = open(\""+path+modelName+"_downtime.z3result\", \"w+\")\n")
            f.write("\tf0.write(\"1\")\n")
            f.write("\tf0.close()\n")
            f.write("\tm = s.model()\n")
            f.write("\tfor d in m.decls():\n")
            # f.write("\t\tprint (\"%s = %s\" % (d.name(), m[d]))\n")
            for varcount in range(1,u_count+1): # Parsing u, attack on u and attacked u values from the z3 py output
                f.write("\t\tif \"attackOnU"+str(varcount)+"_\" in d.name():\n")
                f.write("\t\t\ti = int(d.name().split('_')[1])\n")
                f.write("\t\t\tx = str(m[d])\n")
                f.write("\t\t\tindex = x.find(\"?\")\n")
                f.write("\t\t\tif index != -1:\n")
                f.write("\t\t\t\ty = x[:-1]\n")
                f.write("\t\t\telse:\n")
                f.write("\t\t\t\ty = x\n")
                f.write("\t\t\tattackOnU"+str(varcount)+"[i] = float(y)\n")

                f.write("\t\tif \"uattacked"+str(varcount)+"_\" in d.name():\n")
                f.write("\t\t\ti = int(d.name().split('_')[1])\n")
                f.write("\t\t\tx = str(m[d])\n")
                f.write("\t\t\tindex = x.find(\"?\")\n")
                f.write("\t\t\tif index != -1:\n")
                f.write("\t\t\t\ty = x[:-1]\n")
                f.write("\t\t\telse:\n")
                f.write("\t\t\t\ty = x\n")
                f.write("\t\t\tuattacked"+str(varcount)+"[i] = float(y)\n")

                f.write("\t\tif \"u"+str(varcount)+"_\" in d.name():\n")
                f.write("\t\t\ti = int(d.name().split('_')[1])\n")
                f.write("\t\t\tx = str(m[d])\n")
                f.write("\t\t\tindex = x.find(\"?\")\n")
                f.write("\t\t\tif index != -1:\n")
                f.write("\t\t\t\ty = x[:-1]\n")
                f.write("\t\t\telse:\n")
                f.write("\t\t\t\ty = x\n")
                f.write("\t\t\tu"+str(varcount)+"[i] = float(y)\n")
            for varcount in range(1,x_count+1): # Parsing x, absolute x and z from z3 py output
                f.write("\t\tif \"z"+str(varcount)+"_\" in d.name():\n")
                f.write("\t\t\ti = int(d.name().split('_')[1])\n")
                f.write("\t\t\tx = str(m[d])\n")
                f.write("\t\t\tindex = x.find(\"?\")\n")
                f.write("\t\t\tif index != -1:\n")
                f.write("\t\t\t\ty = x[:-1]\n")
                f.write("\t\t\telse:\n")
                f.write("\t\t\t\ty = x\n")
                f.write("\t\t\tz"+str(varcount)+"[i] = float(y)\n")

                f.write("\t\tif \"xabs"+str(varcount)+"_\" in d.name():\n")
                f.write("\t\t\ti = int(d.name().split('_')[1])\n")
                f.write("\t\t\tx = str(m[d])\n")
                f.write("\t\t\tindex = x.find(\"?\")\n")
                f.write("\t\t\tif index != -1:\n")
                f.write("\t\t\t\ty = x[:-1]\n")
                f.write("\t\t\telse:\n")
                f.write("\t\t\t\ty = x\n")
                f.write("\t\t\txabs"+str(varcount)+"[i] = float(y)\n")

                f.write("\t\tif \"x"+str(varcount)+"_\" in d.name():\n")
                f.write("\t\t\ti = int(d.name().split('_')[1])\n")
                f.write("\t\t\tx = str(m[d])\n")
                f.write("\t\t\tindex = x.find(\"?\")\n")
                f.write("\t\t\tif index != -1:\n")
                f.write("\t\t\t\ty = x[:-1]\n")
                f.write("\t\t\telse:\n")
                f.write("\t\t\t\ty = x\n")
                f.write("\t\t\tx"+str(varcount)+"[i] = float(y)\n")
            for varcount in range(1,y_count+1): # Parsing y, attack on y and r from z3 py output
                f.write("\t\tif \"attackOnY"+str(varcount)+"_\" in d.name():\n")
                f.write("\t\t\ti = int(d.name().split('_')[1])\n")
                f.write("\t\t\tx = str(m[d])\n")
                f.write("\t\t\tindex = x.find(\"?\")\n")
                f.write("\t\t\tif index != -1:\n")
                f.write("\t\t\t\ty = x[:-1]\n")
                f.write("\t\t\telse:\n")
                f.write("\t\t\t\ty = x\n")
                f.write("\t\t\tattackOnY"+str(varcount)+"[i] = float(y)\n")

                f.write("\t\tif \"y"+str(varcount)+"_\" in d.name():\n")
                f.write("\t\t\ti = int(d.name().split('_')[1])\n")
                f.write("\t\t\tx = str(m[d])\n")
                f.write("\t\t\tindex = x.find(\"?\")\n")
                f.write("\t\t\tif index != -1:\n")
                f.write("\t\t\t\ty = x[:-1]\n")
                f.write("\t\t\telse:\n")
                f.write("\t\t\t\ty = x\n")
                f.write("\t\t\ty"+str(varcount)+"[i] = float(y)\n")

                f.write("\t\tif \"r"+str(varcount)+"_\" in d.name():\n")
                f.write("\t\t\ti = int(d.name().split('_')[1])\n")
                f.write("\t\t\tx = str(m[d])\n")
                f.write("\t\t\tindex = x.find(\"?\")\n")
                f.write("\t\t\tif index != -1:\n")
                f.write("\t\t\t\ty = x[:-1]\n")
                f.write("\t\t\telse:\n")
                f.write("\t\t\t\ty = x\n")
                f.write("\t\t\tr"+str(varcount)+"[i] = float(y)\n")

            f.write("\t\tif \"r_\" in d.name():\n")
            f.write("\t\t\ti = int(d.name().split('_')[1])\n")
            f.write("\t\t\tx = str(m[d])\n")
            f.write("\t\t\tindex = x.find(\"?\")\n")
            f.write("\t\t\tif index != -1:\n")
            f.write("\t\t\t\ty = x[:-1]\n")
            f.write("\t\t\telse:\n")
            f.write("\t\t\t\ty = x\n")
            f.write("\t\t\tr[i] = float(y)\n")

            # Printing the execution sequence
            f.write("\tfor i in range({0}):\n".format(K))
            for varcount in  range(1, x_count+1):
                f.write("\t\tprint(\"x"+str(varcount)+"_{0}={1}\".format(i,x"+str(varcount)+"[i]))\n")
            for varcount in  range(1, x_count+1):
                f.write("\t\tprint(\"z"+str(varcount)+"_{0}={1}\".format(i,z"+str(varcount)+"[i]))\n")
            for varcount in  range(1, x_count+1):
                f.write("\t\tprint(\"xabs"+str(varcount)+"_{0}={1}\".format(i,xabs"+str(varcount)+"[i]))\n")
            for varcount in  range(1, u_count+1):
                f.write("\t\tprint(\"attackOnU"+str(varcount)+"_{0}={1}\".format(i,attackOnU"+str(varcount)+"[i]))\n")
            for varcount in  range(1, u_count+1):
                f.write("\t\tprint(\"u"+str(varcount)+"_{0}={1}\".format(i,u"+str(varcount)+"[i]))\n")
            for varcount in  range(1, u_count+1):
                f.write("\t\tprint(\"uattacked"+str(varcount)+"_{0}={1}\".format(i,uattacked"+str(varcount)+"[i]))\n")
            for varcount in  range(1, y_count+1):
                f.write("\t\tprint(\"attackOnY"+str(varcount)+"_{0}={1}\".format(i,attackOnY"+str(varcount)+"[i]))\n")
            for varcount in  range(1, y_count+1):
                f.write("\t\tprint(\"y"+str(varcount)+"_{0}={1}\".format(i,y"+str(varcount)+"[i]))\n")
            for varcount in  range(1, y_count+1):
                f.write("\t\tprint(\"r"+str(varcount)+"_{0}={1}\".format(i,r"+str(varcount)+"[i]))\n")
            f.write("\t\tprint(\"r_{0}={1}\".format(i,r[i]))\n")


            # Printing attack vectors

            for varcount in  range(1, u_count+1):
                f.write("print(\"attack on control signal component {0}\")\n".format(varcount))
                f.write("print(attackOnU{0})\n".format(varcount))
            for varcount in  range(1, y_count+1):
                f.write("print(\"attack on sensor {0}\")\n".format(varcount))
                f.write("print(attackOnY{0})\n".format(varcount))

            f.write("if isSat==1:\n")
            f.write("\tf0 = open(\""+path+modelName+"_downtime.z3result\", \"w+\")\n")
            f.write("\tf0.write(\"1\")\n")
            f.write("\tf0.close()\n")

            f.close()
            os.system("python "+path+fileName+">"+path+fileName+".z3out")
            f0 = open(path+modelName+"_downtime.z3result", "r")
            if f0.mode == 'r':
                content = f0.read()
                isSat = int(content)
            f0.close()
            if isSat==0:
                # os.system("rm -rf "+path+fileName+" "+path+fileName+".z3out")
                os.remove(path+fileName)
                os.remove(path+fileName+".z3out")
            else:
                print("go to "+path+fileName+".z3out \n")
            index = index + 1
        attackLen = attackLen + 1

    final = open(path+modelName+"_final_downtime.result", "a+")
    final.write(str(pattern) + ":" + str(attackLen-2)+"\n")
    final.close()